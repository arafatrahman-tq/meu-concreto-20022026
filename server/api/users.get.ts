import { eq, and } from 'drizzle-orm'
import { users, userCompanies } from '#server/database/schema'
import { db } from '#server/utils/db'

export default defineEventHandler(async (event) => {
  const query = getQuery(event)
  const companyId = query.companyId
    ? parseInt(query.companyId as string)
    : undefined

  let allUsers

  if (companyId) {
    // Return users belonging to this company via junction table
    // Use the company-specific role from user_companies
    allUsers = await db
      .select({
        id: users.id,
        companyId: users.companyId,
        name: users.name,
        email: users.email,
        document: users.document,
        phone: users.phone,
        role: userCompanies.role,
        active: users.active,
        createdAt: users.createdAt,
        updatedAt: users.updatedAt
      })
      .from(users)
      .innerJoin(
        userCompanies,
        and(
          eq(userCompanies.userId, users.id),
          eq(userCompanies.companyId, companyId)
        )
      )
      .all()
  } else {
    allUsers = await db.select().from(users).all()
  }

  return { users: allUsers }
})
