import { eq, desc, and, gte, lte } from 'drizzle-orm'
import { transactions } from '../database/schema'
import { db } from '../utils/db'

export default defineEventHandler(async (event) => {
  const query = getQuery(event)
  const companyId = query.companyId ? parseInt(query.companyId as string) : undefined
  const type = query.type as string
  const status = query.status as string
  const startDate = query.startDate ? new Date(query.startDate as string) : undefined
  const endDate = query.endDate ? new Date(query.endDate as string) : undefined

  try {
    const conditions = []

    if (companyId) conditions.push(eq(transactions.companyId, companyId))
    if (type) conditions.push(eq(transactions.type, type as any))
    if (status) conditions.push(eq(transactions.status, status as any))
    if (startDate) conditions.push(gte(transactions.date, startDate))
    if (endDate) conditions.push(lte(transactions.date, endDate))

    const allTransactions = await db.query.transactions.findMany({
      where: conditions.length > 0 ? and(...conditions) : undefined,
      orderBy: [desc(transactions.date), desc(transactions.createdAt)],
      with: {
        sale: true, // Include sale details if linked
        user: true // Include creator
      }
    })

    return { transactions: allTransactions }
  } catch (e: any) {
    console.error('Get Transactions Error:', e)
    throw createError({
      statusCode: 500,
      statusMessage: 'Internal Server Error',
      data: { message: e.message }
    })
  }
})
